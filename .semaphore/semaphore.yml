version: v1.0
name: skyclerk.com
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: Build app
    task:
      env_vars:
        - name: APP_ENV
          value: local
        - name: HTTP_PORT
          value: "9090"
        - name: SITE_URL
          value: http://localhost:9090
        - name: ENCRYPTION_KEY
          value: adf23423adfasdf1
        - name: CACHE_DIR
          value: /tmp
        - name: OBJECT_REGION
          value: us-west-2
        - name: OBJECT_BUCKET
          value: app.skyclerk.test
        - name: OBJECT_ACCESS_KEY_ID
          value: AKIA54ZFL43BLTGRESRI
        - name: OBJECT_SECRET_ACCESS_KEY
          value: 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
        - name: OBJECT_ENDPOINT
          value: s3.amazonaws.com
        - name: OBJECT_BASE_URL
          value: https://cdn-dev.skyclerk.com
        - name: IMAGINARY_HOST
          value: https://imaginary.skyclerk.com
        - name: IMAGINARY_KEY
          value: AVpirXv4guOH3Q2PKrzKdVzvh
        - name: FONT_PATH
          value: /home/semaphore/go/src/app.skyclerk.com/fonts
        - name: MAIL_DRIVER
          value: smtp
        - name: MAIL_HOST
          value: 127.0.0.1
        - name: MAIL_PORT
          value: "1025"
        - name: STRIPE_MONTHLY_PLAN
          value: "plan_HDPfCGXknOo9h7"
        - name: STRIPE_YEARLY_PLAN
          value: "plan_HDPf88xifqLHOf"
        - name: STRIPE_SECRET_KEY
          value: "sk_test_MX3WpaiQsY9aw5llMHZkBaIK00wiyXUzgd"

      jobs:
      - name: Get app code, get packages, test and build
        commands:
          - env
          - export "GOPATH=$(go env GOPATH)"
          - export "GOBIN=$(go env GOPATH)/bin"
          - export "SEMAPHORE_GIT_DIR=$(go env GOPATH)/src/${SEMAPHORE_PROJECT_NAME}"
          - export "PATH=$GOBIN:${PATH}"
          - mkdir -vp "${SEMAPHORE_GIT_DIR}" "$(go env GOPATH)/bin"
          # - docker run --name skyclerk_com_testing_redis -p 127.0.0.1:9379:6379 -d redis:5.0.4
          # - docker run --name skyclerk_com_testing_mailhog -p 127.0.0.1:1025:1025 -d mailhog/mailhog
          # - docker run --name mariadb-10.20-testing.app.skyclerk.com -e MYSQL_ROOT_PASSWORD=foobar --tmpfs /var/lib/mysql -p 127.0.0.1:9907:3306 -d mariadb:10.2
          - checkout
          - sem-version go 1.11
          - curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh
          - cd $SEMAPHORE_GIT_DIR/backend
          - cd docker
          - docker-compose up -d
          - cd ..
          - dep ensure
          - go test ./...
          - go build -ldflags="-s -w" -o builds/skyclerk
