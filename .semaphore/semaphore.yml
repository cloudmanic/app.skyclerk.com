version: v1.0
name: skyclerk.com
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: Build app
    task:
      env_vars:
        - name: APP_ENV
          value: local
        - name: HTTP_PORT
          value: "9090"
        - name: SITE_URL
          value: http://localhost:9090
        - name: ENCRYPTION_KEY
          value: adf23423adfasdf1
        - name: DB_HOST
          value: tcp(127.0.0.1:9906)
        - name: DB_USERNAME
          value: root
        - name: DB_PASSWORD
          value: foobar
        - name: DB_DATABASE
          value: skyclerk_com
        - name: DB_DATABASE_TESTING
          value: skyclerk_com_testing

      jobs:
      - name: Get app code, get packages, build, test
        commands:
          - env
          - export "GOPATH=$(go env GOPATH)"
          - export "GOBIN=$(go env GOPATH)/bin"
          - export "SEMAPHORE_GIT_DIR=$(go env GOPATH)/src/github.com/cloudmanic/${SEMAPHORE_PROJECT_NAME}"
          - export "PATH=$GOBIN:${PATH}"
          - mkdir -vp "${SEMAPHORE_GIT_DIR}" "$(go env GOPATH)/bin"
          - docker run --name skyclerk_testing -e MYSQL_ROOT_PASSWORD=foobar -e MYSQL_DATABASE=skyclerk_com_testing --tmpfs /var/lib/mysql -p 127.0.0.1:9906:3306 -d mariadb:10.2
          - checkout
          - sem-version go 1.11
          - cd $SEMAPHORE_GIT_DIR
          - go get -t ./...
          #- go test ./controllers/...
          - go build -ldflags="-s -w" -o builds/skyclerk
